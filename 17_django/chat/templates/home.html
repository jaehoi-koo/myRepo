<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body, html {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f7f7f8;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* 사이드바 스타일 */
        .sidebar {
            width: 300px;
            background-color: #202123;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #4d4d4f;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #4d4d4f;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background-color: transparent;
            border: 1px solid #4d4d4f;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .new-chat-btn:hover {
            background-color: #40414f;
        }

        .chatroom-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .chatroom-item {
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            border: none;
            background: transparent;
            color: white;
            text-align: left;
            width: 100%;
            font-size: 14px;
        }

        .chatroom-item:hover {
            background-color: #40414f;
        }

        .chatroom-item.active {
            background-color: #40414f;
        }

        .chatroom-title {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chatroom-preview {
            font-size: 12px;
            color: #8e8ea0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 메인 채팅 영역 스타일 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #e5e5e5;
            background-color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #202123;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 70%;
            overflow-wrap: break-word;
            line-height: 1.5;
        }

        .message.human {
            align-self: flex-end;
            background-color: #007bff;
            color: white;
        }

        .message.ai {
            align-self: flex-start;
            background-color: #f1f3f4;
            color: #202123;
            border: 1px solid #e5e5e5;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e5e5e5;
            background-color: white;
        }

        .chat-input {
            display: flex;
            gap: 12px;
            max-width: 800px;
            margin: 0 auto;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .chat-input input:focus {
            border-color: #007bff;
        }

        .chat-input button {
            padding: 12px 20px;
            border: none;
            border-radius: 24px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .chat-input button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .chat-input button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .chat-input input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .loading {
            opacity: 0.7;
        }

        .typing-indicator {
            font-style: italic;
            color: #666;
        }

        .error {
            background-color: #ffebee !important;
            color: #c62828 !important;
            border: 1px solid #ef5350;
        }

        /* 타이핑 애니메이션 효과 */
        .typing-indicator::after {
            content: '';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }

        /* 빈 상태 스타일 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8e8ea0;
            text-align: center;
        }

        .empty-state h2 {
            margin-bottom: 8px;
            color: #202123;
        }

        .hidden {
            display: none !important;
        }

    </style>
</head>
<body>
    {% csrf_token %}
    <div class="app-container">
        <!-- 사이드바 -->
        <div class="sidebar">
            <div class="sidebar-header">
                <button class="new-chat-btn" id="new-chat-btn">
                    + 새 채팅
                </button>
            </div>
            <div class="chatroom-list" id="chatroom-list">
                <!-- 채팅방 목록이 여기에 동적으로 추가됩니다 -->
            </div>
        </div>

        <!-- 메인 콘텐츠 -->
        <div class="main-content">
            <div class="chat-header">
                <div class="chat-title" id="chat-title">새 채팅을 시작하세요</div>
            </div>

            <div class="chat-container" id="chat-container">
                <div class="empty-state" id="empty-state">
                    <h2>안녕하세요!</h2>
                    <p>새로운 대화를 시작해보세요.</p>
                </div>
            </div>

            <div class="chat-input-container">
                <div class="chat-input">
                    <input type="text" placeholder="메시지를 입력하세요..." id="chat_input"/>
                    <button id="send_btn">전송</button>
                </div>
            </div>
        </div>
    </div>

    <script type="text/javascript">
        // 전역 변수
        let currentChatRoomId = null;
        let chatrooms = [];

        // CSRF 토큰 가져오기
        function getCSRFToken() {
            const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
            console.log('CSRF 토큰:', token);
            return token;
        }

        // Fetch 요청에 CSRF 토큰 포함
        function fetchWithCSRF(url, options = {}) {
            const csrfToken = getCSRFToken();
            const headers = {
                'X-CSRFToken': csrfToken,
                ...options.headers
            };

            console.log('요청 헤더:', headers);
            console.log('요청 URL:', url);

            return fetch(url, {
                ...options,
                headers
            });
        }

        // 페이지 로드 시 초기화
        document.addEventListener('DOMContentLoaded', function() {
            console.log('페이지 로드 완료, 초기화 시작');
            loadChatRooms();
            setupEventListeners();
        });

        // 이벤트 리스너 설정
        function setupEventListeners() {
            document.getElementById('new-chat-btn').addEventListener('click', createNewChatRoom);
            document.getElementById('send_btn').addEventListener('click', sendMessage);
            document.getElementById('chat_input').addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                }
            });
        }

        // 채팅방 목록 로드
        async function loadChatRooms() {
            try {
                console.log('채팅방 목록 로드 시작');
                const response = await fetch('/api/chatrooms/');
                console.log('채팅방 목록 응답:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log('채팅방 목록 데이터:', data);
                chatrooms = data.chatrooms;
                renderChatRoomList();
                console.log('채팅방 목록 렌더링 완료');
            } catch (error) {
                console.error('채팅방 목록 로드 실패:', error);
            }
        }

        // 채팅방 목록 렌더링
        function renderChatRoomList() {
            const chatroomList = document.getElementById('chatroom-list');
            chatroomList.innerHTML = '';

            chatrooms.forEach(room => {
                const roomElement = document.createElement('button');
                roomElement.className = 'chatroom-item';
                roomElement.onclick = () => selectChatRoom(room.id);

                if (room.id === currentChatRoomId) {
                    roomElement.classList.add('active');
                }

                roomElement.innerHTML = `
                    <div class="chatroom-title">${room.title}</div>
                    <div class="chatroom-preview">${room.last_message ? room.last_message.content : '새 채팅'}</div>
                `;

                chatroomList.appendChild(roomElement);
            });
        }

        // 새 채팅방 생성
        async function createNewChatRoom() {
            console.log('createNewChatRoom 함수 호출됨');
            try {
                console.log('API 요청 전송 중...');
                const response = await fetchWithCSRF('/api/chatrooms/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({})
                });

                console.log('API 응답 상태:', response.status);

                if (response.ok) {
                    const newRoom = await response.json();
                    console.log('새 채팅방 생성됨:', newRoom);
                    chatrooms.unshift(newRoom);
                    selectChatRoom(newRoom.id);
                    renderChatRoomList();
                } else {
                    const errorText = await response.text();
                    console.error('새 채팅방 생성 실패:', response.status, errorText);
                    alert(`새 채팅방 생성에 실패했습니다: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.error('새 채팅방 생성 실패:', error);
                alert(`새 채팅방 생성에 실패했습니다: ${error.message}`);
            }
        }

        // 채팅방 선택
        async function selectChatRoom(roomId) {
            currentChatRoomId = roomId;
            await loadMessages(roomId);
            renderChatRoomList(); // 활성 상태 업데이트
        }

        // 메시지 로드
        async function loadMessages(roomId) {
            try {
                const response = await fetch(`/api/chatrooms/${roomId}/messages/`);
                const data = await response.json();

                document.getElementById('chat-title').textContent = data.chatroom_title;
                renderMessages(data.messages);
                hideEmptyState();
            } catch (error) {
                console.error('메시지 로드 실패:', error);
            }
        }

        // 메시지 렌더링
        function renderMessages(messages) {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.innerHTML = '';

            messages.forEach(message => {
                const messageElement = document.createElement('div');
                messageElement.className = `message ${message.sender}`;
                messageElement.textContent = message.content;
                chatContainer.appendChild(messageElement);
            });

            scrollToBottom();
        }

        // 빈 상태 숨기기
        function hideEmptyState() {
            document.getElementById('empty-state').classList.add('hidden');
        }

        // 빈 상태 보이기
        function showEmptyState() {
            document.getElementById('empty-state').classList.remove('hidden');
        }

        // 스크롤을 맨 아래로
        function scrollToBottom() {
            const chatContainer = document.getElementById('chat-container');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // 메시지 전송
        async function sendMessage() {
            console.log('sendMessage 함수 호출됨');
            const message = document.getElementById('chat_input').value.trim();
            console.log('입력된 메시지:', message);

            if (!message) {
                alert('메시지를 입력하세요.');
                return;
            }

            console.log('현재 채팅방 ID:', currentChatRoomId);

            // 현재 채팅방이 없으면 새로 생성
            if (!currentChatRoomId) {
                console.log('새 채팅방 생성 시도');
                await createNewChatRoom();
                console.log('새 채팅방 생성 후 ID:', currentChatRoomId);
                if (!currentChatRoomId) {
                    alert('채팅방 생성에 실패했습니다.');
                    return;
                }
            }

            const chatContainer = document.getElementById('chat-container');
            const chatInput = document.getElementById('chat_input');
            const sendBtn = document.getElementById('send_btn');

            // 빈 상태 숨기기
            hideEmptyState();

            // 즉시 사용자 메시지를 채팅창에 추가
            const userMessage = document.createElement('div');
            userMessage.className = 'message human';
            userMessage.textContent = message;
            chatContainer.appendChild(userMessage);

            // 로딩 메시지 추가
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'message ai loading';
            loadingMessage.innerHTML = '<span class="typing-indicator">AI가 응답 중입니다...</span>';
            chatContainer.appendChild(loadingMessage);

            // 입력창 초기화 및 버튼 비활성화
            chatInput.value = '';
            chatInput.disabled = true;
            sendBtn.disabled = true;
            sendBtn.textContent = '전송 중...';

            scrollToBottom();

            try {
                console.log('메시지 전송 API 호출 시작');
                // 새로운 API를 사용하여 메시지 전송
                const response = await fetchWithCSRF(`/api/chatrooms/${currentChatRoomId}/messages/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                console.log('API 응답 받음:', response.status);

                // 로딩 메시지 제거
                if (chatContainer.contains(loadingMessage)) {
                    chatContainer.removeChild(loadingMessage);
                }

                if (response.ok) {
                    console.log('응답 성공, JSON 파싱 시작');
                    const data = await response.json();
                    console.log('받은 데이터:', data);

                    // AI 응답을 채팅창에 추가
                    if (data.ai_message && data.ai_message.content) {
                        const aiMessage = document.createElement('div');
                        aiMessage.className = 'message ai';
                        aiMessage.textContent = data.ai_message.content;
                        chatContainer.appendChild(aiMessage);
                    } else {
                        console.error('AI 메시지 데이터가 없습니다:', data);
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'message ai error';
                        errorMessage.textContent = 'AI 응답을 받지 못했습니다.';
                        chatContainer.appendChild(errorMessage);
                    }

                    // 채팅방 제목 업데이트
                    if (data.chatroom_title) {
                        document.getElementById('chat-title').textContent = data.chatroom_title;
                    }

                    // 채팅방 목록 새로고침 (임시로 비활성화)
                    // try {
                    //     console.log('채팅방 목록 새로고침 시작');
                    //     await loadChatRooms();
                    //     console.log('채팅방 목록 새로고침 완료');
                    // } catch (listError) {
                    //     console.error('채팅방 목록 새로고침 실패:', listError);
                    //     // 목록 새로고침 실패해도 메시지는 표시되도록 함
                    // }
                    console.log('채팅방 목록 새로고침 건너뜀 (임시)');
                } else {
                    console.error('API 응답 오류:', response.status, response.statusText);
                    const errorText = await response.text();
                    console.error('오류 내용:', errorText);

                    // 에러 메시지 표시
                    const errorMessage = document.createElement('div');
                    errorMessage.className = 'message ai error';
                    errorMessage.textContent = `오류가 발생했습니다: ${response.status} ${response.statusText}`;
                    chatContainer.appendChild(errorMessage);
                }
            } catch (error) {
                console.error('메시지 전송 중 예외 발생:', error);

                // 로딩 메시지 제거
                if (chatContainer.contains(loadingMessage)) {
                    chatContainer.removeChild(loadingMessage);
                }

                // 에러 메시지 표시
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message ai error';
                errorMessage.textContent = `네트워크 오류가 발생했습니다: ${error.message}`;
                chatContainer.appendChild(errorMessage);
            } finally {
                console.log('메시지 전송 처리 완료, UI 복원');
                // 입력창 및 버튼 활성화
                chatInput.disabled = false;
                sendBtn.disabled = false;
                sendBtn.textContent = '전송';
                chatInput.focus();

                scrollToBottom();
            }
        }

    </script>
</body>
</html>